---
title: "Stat 479 Group Project with Matrix and Multiple Logistic Regression"
author: "Basketball Playoff Prediction Team"
date: "Nov 22 2021"
output:
  html_document:
    df_print: paged
header-includes:
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \fancyhf{}
- \rhead{BPP}
- \lhead{STAT 479 GP}
- \cfoot{\thepage}
--- 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, comment=NA, tidy=TRUE, tidy.opts=list(width.cutoff=45), warning=FALSE, message=FALSE, fig.align='center')

library(tidyverse)
library(dplyr)
library(plyr)
library(knitr)
library(rstan)
```

# Merging Data and Data Cleaning

```{r}
Regular <- read.csv("cleaned_data_v1_12_18.csv") # import the data 
Regular$Success <- as.integer(Regular$Y) # add a column of True = 1 and False = 0 from Column "Y"
y <- Regular$Success
deltaOEFF <- Regular[, "deltaOEFF"]
deltaDEFF <- Regular[, "deltaDEFF"]
summary(deltaOEFF) # let the grid for be [-9, 9]
summary(deltaDEFF) # let the grid for be [-9, 9]
# glm(y ~ deltaOEFF + deltaDEFF + 0, data = Regular, family = binomial) # cheat a little
```

## Model

```{r}
y <- Regular$Success # length = 584
deltaOEFF_grid <- seq(-9, 9, by = 0.1) # grid for prediction
deltaDEFF_grid <- seq(-9, 9, by = 0.1) # length = 181
x <- cbind(deltaOEFF, deltaDEFF) # dim(584, 2)
K <- 1
N <- length(y) # N = 584
D <- dim(x)[2] # D = 2
n_grid = length(deltaOEFF_grid) # n_grid = 181
data_list <- list(K = K, # create a list to fill rstan model
                  N = N,
                  D = D,
                  y = y,
                  x = x, 
                  n_grid = n_grid, 
                  deltaOEFF_grid = deltaOEFF_grid, 
                  deltaDEFF_grid = deltaDEFF_grid)
test_stan <- stan_model(file = "test_multi_logit.stan")
fit <- sampling(object = test_stan, data = data_list)
summary(fit)[[1]][,"Rhat"]
```

```{r}
beta1_samples <- rstan::extract(fit, pars = "beta[1,1]")[["beta[1,1]"]] # extract 4000 coefficients 
beta2_samples <- rstan::extract(fit, pars = "beta[2,1]")[["beta[2,1]"]]
mean(beta1_samples)
mean(beta2_samples)
```

As we tune the prior of beta_1 and beta_2, the posterior betas do not change very much. As long as the prior stays within a reasonable range like keeping beta_1 positive and beta_2 negative, the posterior coefficients will stay within the range where beta_1 is around 0.25 and beta_2 around -0.15. This is coherent with the Bayesian characteristic that the posterior probability will be close to the likelihood / observed data if given sufficient data. In our case, we have 584 observed data, which can be considered significantly large. 

# Preliminary visual plots

## Plots for coefficients: 

```{r fig.height = 7, fig.width = 14, fig.align = "center"}
par(mfrow = c(1,2))
hist(beta1_samples, main = "beta_1", breaks = 100, xlab = "beta_1")
hist(beta2_samples, main = "beta_2", breaks = 100, xlab = "beta_2")
```

# Plot

The plots show a spaghetti-shape curve with less weights at mean x and mean y and more weights when x and y-axis approach each range limit. Here we can see that the mean probability has range 0.2 to 0.8 and has 95% credible interval that approaches 0.1 and 0.9 probability. This may show that with deltaOEFF or deltaDEFF, the probability of winning a game may differ from 0.1 to 0.9. 

## Plot the predictive probabilities

```{r fig.height = 8, fig.width = 12, fig.align = "center"}
post_grid_meanD <- rstan::extract(fit, pars = "prob_meanD")[["prob_meanD"]]
prob_meanD_minus_sd <- rstan::extract(fit, pars = "prob_meanD_minus_sd")[["prob_meanD_minus_sd"]]
prob_meanD_plus_sd <- rstan::extract(fit, pars = "prob_meanD_plus_sd")[["prob_meanD_plus_sd"]]
# at mean deltaDEFF
post_grid_meanD_mean <- apply(post_grid_meanD, MARGIN = 2, FUN = mean)
post_grid_meanD_l95 <- apply(post_grid_meanD, MARGIN = 2, FUN = quantile, probs = 0.025)
post_grid_meanD_u95 <- apply(post_grid_meanD, MARGIN = 2, FUN = quantile, probs = 0.975)
# at mean deltaDEFF - sd
prob_meanD_minus_sd_mean <- apply(prob_meanD_minus_sd, MARGIN = 2, FUN = mean)
prob_meanD_minus_sd_l95 <- apply(prob_meanD_minus_sd, MARGIN = 2, FUN = quantile, probs = 0.025)
prob_meanD_minus_sd_u95 <- apply(prob_meanD_minus_sd, MARGIN = 2, FUN = quantile, probs = 0.975)
# at mean deltaDEFF + sd
prob_meanD_plus_sd_mean <- apply(prob_meanD_plus_sd, MARGIN = 2, FUN = mean)
prob_meanD_plus_sd_l95 <- apply(prob_meanD_plus_sd, MARGIN = 2, FUN = quantile, probs = 0.025)
prob_meanD_plus_sd_u95 <- apply(prob_meanD_plus_sd, MARGIN = 2, FUN = quantile, probs = 0.975)
# plot
plot(1, type= "n", xlim = c(-9, 9), ylim = c(0,1),
     main = "Probability with OEFF and fixed DEFF", xlab = "deltaOEFF", ylab = "Probability")
# mean
polygon(x = c(deltaOEFF_grid, rev(deltaOEFF_grid)), 
        y = c(post_grid_meanD_l95, rev(post_grid_meanD_u95)),
        col = alpha("black", 0.8),
        border = NA)
lines(deltaOEFF_grid, post_grid_meanD_mean, lwd = 1.5)
# mean - sd 
polygon(x = c(deltaOEFF_grid, rev(deltaOEFF_grid)), 
        y = c(prob_meanD_minus_sd_l95, rev(prob_meanD_minus_sd_u95)),
        col = alpha("grey", 0.7),
        border = NA)
lines(deltaOEFF_grid, prob_meanD_minus_sd_mean, lwd = 1.5)
# mean + sd
polygon(x = c(deltaOEFF_grid, rev(deltaOEFF_grid)), 
        y = c(prob_meanD_plus_sd_l95, rev(prob_meanD_plus_sd_u95)),
        col = alpha("red", 0.6),
        border = NA)
lines(deltaOEFF_grid, prob_meanD_plus_sd_mean, lwd = 1.5)
legend("bottomright", legend = c("mean_deltaDEFF", "mean_minus_1sd", "mean_plus_1sd"), 
       lty = c(1, 1, 1), lwd = c(2, 2, 2), col = c('black', 'grey', 'red'))
```

The first plot uses all 4000 beta_1s and beta_2s as coefficients of the logistic regression and the second plot only uses the mean of beta_1 and beta_2. The two plots are coherent with each other on the aspect of direction and shape. Here we can see that the x-axis deltaOEFF is positively associated with the posterior probability, where the black line is predictor deltaOEFF when deltaDEFF is at its mean, the grey line is deltaDEFF at mean minus one standard deviation, and the red line is deltaDEFF at mean plus one standard deviation. We can see that the probability of winning a game tends to be the largest at the position of mean deltaOEFF minus one standard deviation. This may be because the two predictors tend to be oppositely plotted, which makes sense in real life as the offensive rate is calculated as the opposite of the other team's defensive rate. 

Now try to fix deltaOEFF and change deltaDEFF

```{r fig.height = 8, fig.width = 12, fig.align = "center"}
post_grid_meanO <- rstan::extract(fit, pars = "prob_meanO")[["prob_meanO"]]
prob_meanO_minus_sd <- rstan::extract(fit, pars = "prob_meanO_minus_sd")[["prob_meanO_minus_sd"]]
prob_meanO_plus_sd <- rstan::extract(fit, pars = "prob_meanO_plus_sd")[["prob_meanO_plus_sd"]]
# at mean deltaOEFF
post_grid_meanO_mean <- apply(post_grid_meanO, MARGIN = 2, FUN = mean)
post_grid_meanO_l95 <- apply(post_grid_meanO, MARGIN = 2, FUN = quantile, probs = 0.025)
post_grid_meanO_u95 <- apply(post_grid_meanO, MARGIN = 2, FUN = quantile, probs = 0.975)
# at mean deltaOEFF - sd
prob_meanO_minus_sd_mean <- apply(prob_meanO_minus_sd, MARGIN = 2, FUN = mean)
prob_meanO_minus_sd_l95 <- apply(prob_meanO_minus_sd, MARGIN = 2, FUN = quantile, probs = 0.025)
prob_meanO_minus_sd_u95 <- apply(prob_meanO_minus_sd, MARGIN = 2, FUN = quantile, probs = 0.975)
# at mean deltaOEFF + sd
prob_meanO_plus_sd_mean <- apply(prob_meanO_plus_sd, MARGIN = 2, FUN = mean)
prob_meanO_plus_sd_l95 <- apply(prob_meanO_plus_sd, MARGIN = 2, FUN = quantile, probs = 0.025)
prob_meanO_plus_sd_u95 <- apply(prob_meanO_plus_sd, MARGIN = 2, FUN = quantile, probs = 0.975)
# plot
plot(1, type= "n", xlim = c(-9, 9), ylim = c(0,1),
     main = "Probability with DEFF and fixed OEFF", xlab = "deltaDEFF", ylab = "Probability")
# mean
polygon(x = c(deltaDEFF_grid, rev(deltaDEFF_grid)), 
        y = c(post_grid_meanO_l95, rev(post_grid_meanO_u95)),
        col = alpha("black", 0.8),
        border = NA)
lines(deltaDEFF_grid, post_grid_meanO_mean, lwd = 1.5)
# mean - sd 
polygon(x = c(deltaDEFF_grid, rev(deltaDEFF_grid)), 
        y = c(prob_meanO_minus_sd_l95, rev(prob_meanO_minus_sd_u95)),
        col = alpha("grey", 0.7),
        border = NA)
lines(deltaDEFF_grid, prob_meanO_minus_sd_mean, lwd = 1.5)
# mean + sd
polygon(x = c(deltaDEFF_grid, rev(deltaDEFF_grid)), 
        y = c(prob_meanO_plus_sd_l95, rev(prob_meanO_plus_sd_u95)),
        col = alpha("red", 0.6),
        border = NA)
lines(deltaDEFF_grid, prob_meanO_plus_sd_mean, lwd = 1.5)
legend("bottomleft", legend = c("mean_deltaOEFF", "mean_minus_1sd", "mean_plus_1sd"), 
       lty = c(1, 1, 1), lwd = c(2, 2, 2), col = c('black', 'grey', 'red'))
```

Similar plots with similar explanations. The probability of winning is roughly negatively associated with the predictor deltaDEFF. 


# Zsun: Simulation

```{r}
source("zsun_playoff_simulator.R")

set.seed(20211129)
pairwise_data <- read.csv("pairwise_DEFF_OEFF_2019.csv")
champions_4000 <- rep()
prob_matrix_4000 <- list()
for (i in 1:4000){
  simu_i_prob <- pairwise_data %>% 
    mutate(p = exp(d_OEFF * beta1_samples[i] + d_DEFF * beta2_samples[i])/ (1 + exp(d_OEFF * beta1_samples[i] + d_DEFF * beta2_samples[i])))
  prob_matrix_i <- matrix(simu_i_prob$p,nrow=16,ncol=16)
  name <- pairwise_data[1:16,1]
  colnames(prob_matrix_i) <- name
  rownames(prob_matrix_i) <- name
  prob_matrix_4000[[i]] <- prob_matrix_i # store the probability matrix
  champions_4000[i] <- simu_final(P = prob_matrix_i)[1] # store the simu_result
}
table(champions_4000)/4000
length(prob_matrix_4000)
```

# MSE

```{r}
Regular_19 <- read.csv("cleaned_data_v1_19.csv") # import the data 
Regular_19$Success <- as.integer(Regular_19$Y)
deltaOEFF_19 <- Regular_19$deltaOEFF
deltaDEFF_19 <- Regular_19$deltaDEFF
predicted <- mean(beta1_samples) * deltaOEFF_19 + mean(beta2_samples) * deltaDEFF_19
pred_prob <- exp(predicted)/(exp(predicted) + 1)
observed <- Regular_19$Success
(sum(observed - pred_prob)^2)/length(pred_prob)
```












